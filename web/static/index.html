<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>IngestLab</title>
    <link rel="stylesheet" href="/styles.css?v=20250129b" />
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%230a223f'/%3E%3Cpath d='M18 42l14-20 14 20-14-7z' fill='%23f5a524'/%3E%3C/svg%3E" />
    <!-- Prefer local vendor copy (server auto-fetches if missing), fallback to CDN -->
    <script>
      (function() {
        function loadScript(src) {
          return new Promise(function(resolve, reject) {
            var s = document.createElement('script');
            s.src = src;
            s.async = false;
            s.onload = resolve;
            s.onerror = reject;
            document.head.appendChild(s);
          });
        }
        window.loadScript = loadScript;
        window.__pdfReady = (async function ensurePdfjs(){
          const sources = [
            '/vendor/pdfjs/pdf.min.js',
            'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js',
            'https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js',
          ];
          for (const src of sources) {
            try {
              await loadScript(src);
              if (window.pdfjsLib) break;
            } catch (e) {}
          }
          if (window.pdfjsLib) {
            // Point worker to local first, then CDN fallbacks.
            const workerCandidates = [
              '/vendor/pdfjs/pdf.worker.min.js',
              'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js',
              'https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.worker.min.js',
            ];
            window.pdfjsLib.GlobalWorkerOptions.workerSrc = workerCandidates[0];
          }
          return window.pdfjsLib;
        })();
        window.__mdReady = (async function ensureMarkdown(){
          async function loadAny(sources, globalName) {
            for (const src of sources) {
              try {
                await loadScript(src);
                if (window[globalName]) return window[globalName];
              } catch (e) {}
            }
            return null;
          }
          const dompurify = await loadAny([
            '/vendor/dompurify/purify.min.js',
            'https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js',
            'https://unpkg.com/dompurify@3.1.6/dist/purify.min.js'
          ], 'DOMPurify');
          const marked = await loadAny([
            '/vendor/marked/marked.min.js',
            'https://cdn.jsdelivr.net/npm/marked@12.0.2/marked.min.js',
            'https://unpkg.com/marked@12.0.2/marked.min.js'
          ], 'marked');
          if (!dompurify || !marked) {
            console.warn('Markdown rendering unavailable; falling back to plain text');
            return null;
          }
          try {
            marked.setOptions({ breaks: true });
          } catch (_) {}
          return { DOMPurify: dompurify, marked };
        })();
      })();
    </script>
  </head>
  <body>
    <div id="tooltip-portal"></div>
    <header>
      <div class="header-left">
        <div class="title-stack">
          <h1>IngestLab</h1>
          <span class="version-badge" id="versionBadge" title="What's new">v6.1.3</span>
        </div>
        <div class="view-tabs" role="tablist" aria-label="Primary view">
          <button id="viewTabInspect" class="tab active" data-view="inspect" role="tab" aria-selected="true">Inspect</button>
          <button id="viewTabFeedback" class="tab" data-view="feedback" role="tab" aria-selected="false">Feedback</button>
          <button id="viewTabImages" class="tab" data-view="images" role="tab" aria-selected="false">
            Images
            <span class="experimental-badge">EXPERIMENTAL</span>
          </button>
        </div>
      </div>
      <div class="controls">
        <label class="extraction-picker">
          <span class="lab">Extraction <span id="mainFormatBadge" class="format-badge" style="display:none;"></span></span>
          <select id="extractionSelect"></select>
        </label>
        <button id="reviewSummaryChip" class="review-chip disabled" type="button" title="Click Elements or Chunks to focus reviews"></button>
        <button id="openExtractionModal" class="btn">New Extraction</button>
        <button id="openChunkerModal" class="btn">New Chunker</button>
        <button id="deleteExtractionBtn" class="btn" title="Delete current extraction">Delete Extraction</button>
        <button id="themeToggle" class="btn btn-icon" type="button" title="Toggle dark/light theme" aria-label="Toggle theme">
          <svg id="themeIconSun" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="5"/>
            <line x1="12" y1="1" x2="12" y2="3"/>
            <line x1="12" y1="21" x2="12" y2="23"/>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
            <line x1="1" y1="12" x2="3" y2="12"/>
            <line x1="21" y1="12" x2="23" y2="12"/>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
          </svg>
          <svg id="themeIconMoon" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" style="display:none">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
          </svg>
        </button>
      </div>
    </header>

  <main>
    <div id="inspectShell" class="inspect-shell">
      <section class="left">
        <div class="page-controls">
          <button id="prevPage">◀</button>
          <span>Page <input type="number" id="pageNum" value="1" min="1"> / <span id="pageCount">-</span></span>
          <button id="nextPage">▶</button>
          <input type="range" id="zoom" min="50" max="200" value="100" />
          <button id="fitWidth" title="Fit to width">↔</button>
          <button id="fitHeight" title="Fit to height">↕</button>
        </div>
        <div id="pdfContainer">
          <div id="legend" class="legend hidden"></div>
          <div class="page-layer">
            <canvas id="pdfCanvas"></canvas>
            <div id="overlay"></div>
          </div>
        </div>
      </section>

      <!-- Right panel: Inspect view -->
      <section class="right" id="right-inspect" aria-labelledby="viewTabInspect">
        <div class="resize-handle" id="drawer-resize-handle" title="Drag to resize, double-click to reset"></div>
        <div class="tabs inspect-tabs">
          <button class="tab active" data-inspect="elements">Elements</button>
          <button class="tab" data-inspect="chunks">Chunks</button>
        </div>
        <div id="pane-inspect-elements" class="pane active">
          <div class="elements-view">
            <div class="card element-summary">
              <div class="row">
                <label>
                  <span class="lab">Type</span>
                  <select id="elementsTypeSelect"></select>
                </label>
                <label>
                  <span class="lab">Review</span>
                  <select id="elementsReviewSelect">
                    <option value="All">All</option>
                    <option value="Reviewed">Reviewed</option>
                    <option value="Good">Good only</option>
                    <option value="Bad">Bad only</option>
                  </select>
                </label>
                <div id="elementViewToggle" class="view-toggle hidden" role="group" aria-label="Element view mode">
                  <button type="button" class="toggle-btn" data-mode="flat">Flat</button>
                  <button type="button" class="toggle-btn active" data-mode="outline">Outline</button>
                  <span class="info" tabindex="0">i</span>
                  <div class="tip">Outline (Azure runs only) orders elements by reading position per page, groups into Page Header/Number, Tables, Paragraphs, and Lines, numbers each type, and lets you collapse long pages.</div>
                </div>
              </div>
              <div id="elementPagination" class="element-pagination"></div>
              <div class="collapsible-stats">
                <div id="typesList" class="types element-types"></div>
                <div id="elementsReviewSummary" class="element-stats-detail"></div>
              </div>
            </div>
            <div class="elements-list" id="elementsList"></div>
          </div>
        </div>
        <div id="pane-inspect-chunks" class="pane">
          <div class="chunks-view">
            <div id="chunkSummary" class="card chunk-summary"></div>
            <div id="chunkList" class="chunk-list"></div>
          </div>
        </div>
      </section>

      <aside id="drawer" class="drawer hidden">
        <div class="drawer-resize-handle" id="drawer-overlay-resize-handle" title="Drag to resize, double-click to reset"></div>
        <div class="drawer-header">
          <div>
            <div id="drawerTitle" class="drawer-title">Unstructured Chunks</div>
            <div id="drawerMeta" class="drawer-meta"></div>
            <div id="drawerSummary" class="mini-metrics compact"></div>
          </div>
          <button id="drawerClose" class="btn">Close</button>
        </div>
        <div class="drawer-content">
          <div id="elementPicker" class="element-picker"></div>
          <div id="preview" class="table-preview">
            <div class="placeholder">Select an Unstructured chunk to preview its extracted table</div>
          </div>
        </div>
      </aside>
    </div>

    <section id="feedbackView" class="feedback-view hidden" aria-labelledby="viewTabFeedback">
      <div class="feedback-toolbar card">
        <div class="toolbar-row">
          <label>
            <span class="lab">Provider scope</span>
            <select id="feedbackProviderSelect">
              <option value="all">All providers</option>
              <option value="unstructured/local">Unstructured (Local) — Deprecated</option>
              <option value="unstructured/partition">Unstructured Partition (API) — Deprecated</option>
              <option value="azure/document_intelligence">Azure Document Intelligence</option>
              <option value="compare">Compare all providers</option>
            </select>
          </label>
          <div class="spacer"></div>
          <button id="feedbackExportJson" class="btn btn-secondary" type="button">Download JSON</button>
          <button id="feedbackExportHtml" class="btn btn-secondary" type="button">Download HTML</button>
        </div>
      </div>

      <div class="feedback-grid">
        <div class="card stat-card" id="feedbackCardOverall">
          <div class="stat-label">Overall</div>
          <div class="stat-values">
            <span class="stat-good" id="feedbackOverallGood">0</span>
            <span class="stat-sep">/</span>
            <span class="stat-bad" id="feedbackOverallBad">0</span>
            <span class="stat-total" id="feedbackOverallTotal">0</span>
          </div>
          <div class="stat-sub" id="feedbackOverallScore">
            <span class="muted">Score:</span>
            <span id="feedbackOverallScoreValue">-</span>
            <span class="inline-tip">
              <span class="info" aria-label="Scoring help" role="img">?</span>
              <span class="tip">Smoothed good rate: (good+3)/(good+bad+6) × 100. Confidence derives from total feedback volume.</span>
            </span>
          </div>
          <div class="stat-sub" id="feedbackNoteCount">0 notes</div>
        </div>
        <div class="card stat-card" id="feedbackCardLatest">
          <div class="stat-label">Latest</div>
          <div class="stat-sub" id="feedbackLatestExtraction">-</div>
          <div class="stat-sub muted" id="feedbackLatestUpdated">-</div>
        </div>
        <div class="card stat-card" id="feedbackCardProviders">
          <div class="stat-label">Providers</div>
          <div class="stat-sub" id="feedbackProviderBreakdown">-</div>
          <div class="stat-sub" id="feedbackProviderScores">
            <span id="feedbackProviderScoresValue">-</span>
            <span class="inline-tip">
              <span class="info" aria-label="Provider scoring help" role="img">?</span>
              <span class="tip">Per-provider smoothed score: (good+3)/(good+bad+6) × 100. Confidence comes from feedback count.</span>
            </span>
          </div>
        </div>
      </div>

      <div class="card feedback-chart-card">
        <div class="card-title-row">
          <div class="card-title">Good vs Bad by provider</div>
          <span class="muted" id="feedbackChartHint"></span>
        </div>
        <canvas id="feedbackChart" aria-label="Feedback distribution chart"></canvas>
      </div>

      <div class="card feedback-chart-card">
        <div class="card-title-row">
          <div class="card-title">Provider scores (0-100)</div>
          <span class="muted" id="feedbackScoreChartHint"></span>
        </div>
        <canvas id="feedbackScoreChart" aria-label="Feedback score chart"></canvas>
      </div>

      <div class="card feedback-extractions-card">
        <div class="card-title-row">
          <div class="card-title">Extractions with feedback</div>
          <input id="feedbackSearch" placeholder="Filter by slug or PDF" />
        </div>
        <div id="feedbackExtractions" class="feedback-extractions"></div>
      </div>

      <div class="card feedback-analysis-card">
        <div class="card-title-row">
          <div class="card-title">LLM analysis</div>
          <div class="btn-row">
            <button id="feedbackAnalyzeBtn" class="btn" type="button">Send to LLM</button>
            <button id="feedbackCopyBtn" class="btn btn-secondary" type="button">Copy</button>
            <span id="feedbackStatus" class="muted"></span>
          </div>
        </div>
        <pre id="feedbackAnalysis" class="analysis-output" aria-live="polite"></pre>
      </div>
    </section>

    <!-- Images View (EXPERIMENTAL) -->
    <section id="imagesView" class="images-view hidden" aria-labelledby="viewTabImages">
      <div class="images-header card">
        <div class="images-mode-tabs">
          <button class="mode-tab active" data-mode="pdf-figures">PDF Figures</button>
          <button class="mode-tab" data-mode="upload">Upload Figure</button>
        </div>
        <div class="experimental-notice">
          This feature requires the PolicyAsCode figure-vision branch.
        </div>
      </div>

      <!-- PDF Figures Panel -->
      <div id="imagesPdfFiguresPanel" class="images-panel">
        <div id="imagesStats" class="images-stats card"></div>
        <div class="images-content">
          <div id="imagesFigureList" class="figure-list">
            <div class="empty-state">Select an extraction to view figures</div>
          </div>
          <div id="imagesFigureDetails" class="figure-details hidden"></div>
        </div>
      </div>

      <!-- Upload Panel with Unified Layout -->
      <div id="imagesUploadPanel" class="images-panel hidden">
        <div class="images-unified-layout">
          <!-- History Sidebar with Compact Upload Zone -->
          <aside class="upload-history-sidebar">
            <!-- Compact Upload Zone -->
            <div class="compact-upload-zone" id="compactUploadZone">
              <div class="compact-upload-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                  <polyline points="17,8 12,3 7,8"/>
                  <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
              </div>
              <span class="compact-upload-text">Drop or browse</span>
              <input type="file" id="imageUploadInput" accept="image/png,image/jpeg,image/webp" hidden />
            </div>

            <div class="upload-history-header">
              <h4>History</h4>
              <button id="refreshHistoryBtn" class="btn btn-icon" title="Refresh history">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="23,4 23,10 17,10"/>
                  <polyline points="1,20 1,14 7,14"/>
                  <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                </svg>
              </button>
            </div>
            <div id="uploadHistoryList" class="upload-history-list">
              <div class="empty-state">No previous uploads</div>
            </div>
          </aside>

          <!-- Main Area -->
          <div class="images-main-area">
            <div class="upload-container card">
              <form id="imageUploadForm" class="upload-form">
                <div id="imageUploadZone" class="upload-zone">
                  <div class="upload-icon">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                      <polyline points="17,8 12,3 7,8"/>
                      <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                  </div>
                  <p class="upload-text">Drop an image here or click to browse</p>
                  <p class="upload-hint">Supports PNG, JPEG, WebP</p>
                </div>
              </form>
              <div id="imageUploadResult" class="upload-result-container"></div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

    <div id="toast" class="toast"></div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal hidden">
      <div class="modal-backdrop" id="confirmModalBackdrop"></div>
      <div class="modal-content card confirm-modal">
        <div class="confirm-modal-body">
          <div class="confirm-modal-title" id="confirmModalTitle">Confirm</div>
          <div class="confirm-modal-message" id="confirmModalMessage">Are you sure?</div>
          <div class="confirm-modal-actions">
            <button id="confirmModalCancelBtn" class="btn btn-cancel">Cancel</button>
            <button id="confirmModalConfirmBtn" class="btn btn-confirm">OK</button>
          </div>
        </div>
      </div>
    </div>

    <!-- New Extraction Modal -->
    <div id="extractionModal" class="modal hidden">
      <div class="modal-backdrop" id="extractionModalBackdrop"></div>
      <div class="modal-content card">
        <div class="modal-header">
          <div class="modal-title">New Extraction</div>
          <button id="closeExtractionModal" class="btn">Close</button>
        </div>
        <div class="extraction-modal-body">
          <div class="extraction-preview" id="extractionPreviewPane">
            <div class="extraction-preview-controls">
              <span id="extractionFormatBadge" class="format-badge" style="display:none;"></span>
              <button id="extractionPrev" class="btn">◀</button>
              <span>Page <span id="extractionPageNum">-</span> / <span id="extractionPageCount">-</span></span>
              <button id="extractionNext" class="btn">▶</button>
              <span class="sep"></span>
              <button id="addPageBtn" class="btn">Add page</button>
              <button id="markStartBtn" class="btn">Mark start</button>
              <button id="markEndBtn" class="btn">Mark end</button>
              <span id="rangeHint" class="muted"></span>
            </div>
            <div class="extraction-canvas-wrap">
              <canvas id="extractionPdfCanvas"></canvas>
              <span id="pdfSelectFormatBadge" class="format-badge preview-overlay-badge" style="display:none;"></span>
              <div id="extractionPreviewMessage" class="preview-message" style="display:none;"></div>
            </div>
          </div>
          <div class="extraction-grid" id="extractionFormGrid">
            <div class="document-upload-row">
              <label class="upload-picker">
                <div class="lab">Upload <span class="info" tabindex="0">i</span><div class="tip">Upload a document (PDF, Office, or image) to the server for extraction.</div></div>
                <input id="pdfUploadInput" type="file" accept=".pdf,.docx,.xlsx,.pptx,.jpg,.jpeg,.png,.bmp,.tiff,.tif,.heif" />
              </label>
              <label class="document-picker">
                <div class="lab">Document <span class="info" tabindex="0">i</span><div class="tip">Pick a document from the server. Use Delete to remove the selected file.</div></div>
                <div class="document-select-row">
                  <select id="pdfSelect"></select>
                  <button id="pdfDeleteBtn" class="btn btn-secondary" type="button" title="Delete selected document from server">Delete</button>
                </div>
              </label>
              <span id="pdfUploadStatus" class="muted"></span>
            </div>
            <div class="provider-lang-row">
              <label class="provider-picker">
                <div class="lab">Provider <span class="info" tabindex="0">i</span><div class="tip">Unstructured (local library), Unstructured Partition (hosted API, elements only), or Azure Document Intelligence (Layout).</div></div>
                <select id="providerSelect">
                  <option value="unstructured/local" disabled>Unstructured (Local) — Deprecated</option>
                  <option value="unstructured/partition" disabled>Unstructured Partition (API) — Deprecated</option>
                  <option value="azure/document_intelligence" selected>Azure Document Intelligence (Layout)</option>
                </select>
              </label>
              <label class="lang-picker azure-hidden">
                <div class="lab">UI primary language <span class="info" tabindex="0">i</span><div class="tip">Affects preview direction only. Azure extractions rely on built-in language detection; Unstructured also forwards OCR hints.</div></div>
                <select id="docLanguage">
                  <option value="eng" selected>English (LTR)</option>
                  <option value="ara">Arabic (RTL)</option>
                </select>
              </label>
            </div>
            <label>
              <div class="lab">Pages <span class="info" tabindex="0">i</span><div class="tip">Comma‑separated pages and ranges, e.g., <code>5-7,12</code>. Leave blank to process the entire document.</div></div>
              <input id="pagesInput" placeholder="e.g. 4-6 or 4,5,6 (blank = all)" />
            </label>
            <div id="unstructuredSettings" class="unstructured-settings unstructured-only">
              <div class="lab">Unstructured options</div>
              <div class="unstructured-options">
                <label>
                  <div class="lab">Strategy <span class="info" tabindex="0">i</span><div class="tip">Unstructured extraction mode: <b>auto</b> (choose for you), <b>fast</b> (lighter), <b>hi_res</b> (layout-aware), <b>ocr_only</b> (OCR-first), or <b>vlm</b> (vision language model extraction for images/PDFs).</div></div>
                  <select id="strategySelect">
                    <option value="auto">auto</option>
                    <option value="fast">fast</option>
                    <option value="hi_res">hi_res</option>
                    <option value="ocr_only">ocr_only</option>
                    <option value="vlm">vlm</option>
                  </select>
                </label>
                <label class="checkbox">
                  <input id="inferTables" type="checkbox" checked />
                  <span class="lab">Infer table structure <span class="info" tabindex="0">i</span><div class="tip">Rebuild table rows and cells from lines/glyphs for more accurate tables.</div></span>
                </label>
                <label>
                  <div class="lab">Extract image block types <span class="info" tabindex="0">i</span><div class="tip">Optional CSV list sent to Unstructured Partition API (e.g., <code>Image</code> or <code>Image,Table</code>) to return image blocks and crops.</div></div>
                  <input id="extractImageBlockTypes" placeholder="e.g. Image,Table" />
                </label>
                <label class="checkbox">
                  <input id="extractImageToPayload" type="checkbox" />
                  <span class="lab">Embed extracted images in payload <span class="info" tabindex="0">i</span><div class="tip">Set <code>extract_image_block_to_payload=true</code> so image bytes are returned as base64 alongside metadata.</div></span>
                </label>
              </div>
            </div>
            <label>
              <div class="lab">Variant tag (optional) <span class="info" tabindex="0">i</span><div class="tip">Optional label appended to the extraction slug for side‑by‑side comparisons (e.g., <code>hires-2k</code>).</div></div>
              <input id="variantTag" placeholder="e.g. hi-res-tuned" />
            </label>
            <div id="azureSettings" class="azure-settings hidden">
              <div class="lab">Azure Analyze options</div>
              <div class="azure-options">
                <div class="opt-group">
                  <div class="lab sm">Output format <span class="info" tabindex="0">i</span><div class="tip">Markdown preserves layout and headings; Text returns plain strings. Azure defaults to markdown.</div></div>
                  <label class="radio"><input type="radio" name="azureOutputFormat" value="text" /> Text</label>
                  <label class="radio"><input type="radio" name="azureOutputFormat" value="markdown" checked /> Markdown</label>
                </div>
                <div class="opt-group">
                  <div class="lab sm">Optional output <span class="info" tabindex="0">i</span><div class="tip">Attach extracted figure images to the markdown/text response.</div></div>
                  <label class="checkbox"><input type="checkbox" id="azureFigureImage" /> Figure image</label>
                </div>
                <div class="opt-group">
                  <div class="lab sm">Optional detection <span class="info" tabindex="0">i</span><div class="tip">Enable extra detectors: barcodes, language hints, and key-value pairs.</div></div>
                  <label class="checkbox"><input type="checkbox" id="azureBarcodes" /> Barcodes</label>
                  <label class="checkbox"><input type="checkbox" id="azureLanguage" checked /> Language</label>
                  <label class="checkbox"><input type="checkbox" id="azureKvp" /> Key-value pairs</label>
                </div>
                <div class="opt-group">
                  <div class="lab sm">Premium detection <span class="info" tabindex="0">i</span><div class="tip">Paid add-ons: high-res OCR, font/style metadata, and formula detection.</div></div>
                  <label class="checkbox"><input type="checkbox" id="azureHighRes" /> High resolution</label>
                  <label class="checkbox"><input type="checkbox" id="azureStyleFont" /> Style font</label>
                  <label class="checkbox"><input type="checkbox" id="azureFormulas" /> Formulas</label>
                </div>
              </div>
              <details class="azure-advanced">
                <summary>Advanced (model, locale…)</summary>
                <label>
                  <div class="lab">Model id <span class="info" tabindex="0">i</span><div class="tip">Document Intelligence defaults to <code>prebuilt-layout</code>.</div></div>
                  <input id="azureModelId" placeholder="prebuilt-layout" />
                </label>
                <label>
                  <div class="lab">Locale <span class="info" tabindex="0">i</span><div class="tip">Locale hint for OCR/analysis (e.g., <code>en-US</code>, <code>ar-AE</code>).</div></div>
                  <input id="azureLocale" placeholder="e.g. en-US" />
                </label>
                <label>
                  <div class="lab">String index type <span class="info" tabindex="0">i</span><div class="tip">String index type (e.g., <code>unicodeCodePoint</code>).</div></div>
                  <input id="azureStringIndexType" placeholder="e.g. unicodeCodePoint" />
                </label>
                <label>
                  <div class="lab">Query fields <span class="info" tabindex="0">i</span><div class="tip">Comma-separated fields when using query-based extraction.</div></div>
                  <input id="azureQueryFields" placeholder="e.g. invoiceDate,total" />
                </label>
              </details>
            </div>
            <div class="extraction-actions">
              <button id="cancelExtractionBtn" class="btn btn-secondary" type="button">Cancel</button>
              <button id="extractionBtn" class="btn">Extract</button>
              <span id="extractionStatus" class="muted"></span>
            </div>
          </div>
        </div>
        <div class="extraction-progress" id="extractionProgressPane">
          <div class="extraction-progress-inner">
            <div class="extraction-spinner" id="extractionSpinner" aria-hidden="true"></div>
            <div class="extraction-progress-text" id="extractionProgressTitle">Extracting…</div>
            <div class="extraction-progress-status muted" id="extractionProgressStatus"></div>
            <div class="extraction-progress-subtitle muted" id="extractionProgressHint"></div>
            <div class="extraction-progress-bar-wrap" id="extractionProgressBarWrap" style="display:none;">
              <div class="extraction-progress-detail" id="extractionProgressDetail"></div>
            </div>
            <pre id="extractionProgressLogs" class="extraction-progress-logs"></pre>
          </div>
        </div>
      </div>
    </div>

    <!-- Chunker Modal -->
    <div id="chunkerModal" class="modal hidden">
      <div class="modal-backdrop" id="chunkerModalBackdrop"></div>
      <div class="modal-content card chunker-modal">
        <div class="modal-header">
          <div class="modal-title">Chunk Extraction</div>
          <button id="closeChunkerModal" class="btn">Close</button>
        </div>
        <div class="chunker-modal-body">
          <div class="chunker-form">
            <label class="source-extraction-picker">
              <div class="lab">Source Extraction <span class="info" tabindex="0">i</span><div class="tip">Select an existing extraction with elements to chunk.</div></div>
              <select id="chunkerSourceExtraction"></select>
            </label>
            <div class="chunker-description card">
              <div class="lab">How this chunker works</div>
              <ul class="chunker-rules">
                <li>Filters noise types: pageHeader, pageFooter, pageNumber, Line.</li>
                <li>Tables and Figures become standalone chunks (never split).</li>
                <li>Titles/section headings start new chunks and stay with the following content.</li>
                <li>Section headings inside Table/Figure boxes stay attached to the container (captions stay with figures).</li>
                <li>Consecutive section headings merge into a single section (no header-only chunks).</li>
                <li>Content before the first heading is grouped as a preamble chunk.</li>
                <li>Paragraphs inside Table bounding boxes are filtered to avoid duplicate content.</li>
                <li>Original elements stay embedded for overlays; chunks can span pages when elements do.</li>
              </ul>
            </div>
            <div class="chunker-actions">
              <button id="runChunkerBtn" class="btn btn-primary">Run Chunker</button>
              <span id="chunkerStatus" class="muted"></span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- What's New Modal -->
    <div id="whatsNewModal" class="modal hidden">
      <div class="modal-backdrop" id="whatsNewBackdrop"></div>
      <div class="modal-content card whats-new-modal">
        <div class="modal-header">
          <div class="modal-title">What's New</div>
          <button id="closeWhatsNew" class="btn">Close</button>
        </div>
        <div class="whats-new-body">
          <div class="version-section">
            <h3 class="version-header">v6.1.3 <span class="version-date">2026-02-02</span></h3>
            <ul>
              <li>Fix: Modal viewport overflow causing cutoff on deployed environments (improved defensive CSS)</li>
            </ul>
          </div>
          <div class="version-section">
            <h3 class="version-header">v6.1.2 <span class="version-date">2026-01-30</span></h3>
            <ul>
              <li><strong>Modal SAM3 Backend</strong>: Added optional Modal serverless deployment support for SAM3 segmentation</li>
              <li>Documentation: Updated .env.example with Modal deployment instructions</li>
            </ul>
          </div>
          <div class="version-section">
            <h3 class="version-header">v6.1.1 <span class="version-date">2026-01-30</span></h3>
            <ul>
              <li>Fix: Modal viewport overflow causing cutoff on deployed environments</li>
            </ul>
          </div>
          <div class="version-section">
            <h3 class="version-header">v6.1.0 <span class="version-date">2026-01-30</span></h3>
            <ul>
              <li><strong>Run → Extraction Rename</strong>: Terminology updated across UI for clarity</li>
              <li><strong>Multi-format Upload</strong>: Upload DOCX, XLSX, PPTX, and image files directly</li>
              <li><strong>Figure Understanding</strong>: View figure analysis in chunk details and element views</li>
              <li><strong>Image Type Override</strong>: Reprocess existing figures with different type classifications</li>
              <li><strong>Progress Pipeline</strong>: Real-time stage visualization during extractions</li>
              <li><strong>Upload Tab Redesign</strong>: New sidebar layout with reprocess button</li>
              <li><strong>Custom Modals</strong>: Native confirm() dialogs replaced with styled in-app modals</li>
              <li>Fix: Image extractions display at correct zoom level in viewer</li>
              <li>Fix: PDF figure extraction with full SAM3 data and coordinate scaling</li>
              <li>Fix: Match figure type badges in upload history with PDF Figures tab</li>
            </ul>
          </div>
          <div class="version-section">
            <h3 class="version-header">v6.0.0 <span class="version-date">2026-01-27</span></h3>
            <ul>
              <li><strong>Images Tab</strong>: New top-level tab for exploring PDF figures and standalone image uploads</li>
              <li><strong>Two-stage Vision Pipeline</strong>: Interactive SAM3 segmentation preview + separate Mermaid diagram extraction</li>
              <li><strong>Cytoscape Visualization</strong>: Interactive graph rendering for extracted diagrams with fullscreen mode</li>
              <li><strong>Upload History</strong>: Track and manage previously uploaded images with deletion support</li>
              <li><strong>Lightbox</strong>: Zoomable image previews with keyboard navigation</li>
              <li><strong>Text Position Extraction</strong>: Azure DI OCR for uploaded images improves Mermaid label accuracy</li>
              <li><strong>Reasoning Trace Display</strong>: View LLM reasoning steps in the pipeline view</li>
              <li>Frontend refactored into domain-specific CSS and JS modules for better maintainability</li>
              <li>Pipeline steps now update incrementally during processing</li>
              <li>Improved Cytoscape node layout with proper aspect ratio preservation</li>
            </ul>
          </div>
          <div class="version-section">
            <h3 class="version-header">v5.0.4 <span class="version-date">2025-01-22</span></h3>
            <ul>
              <li>Fix: Chunker endpoint properly converts element dicts to Pydantic models before chunking</li>
              <li>Fix: Extraction pipeline correctly serializes Pydantic models (DetectedLanguage) to JSON output</li>
            </ul>
          </div>
          <div class="version-section">
            <h3 class="version-header">v5.0.3 <span class="version-date">2025-12-02</span></h3>
            <ul>
              <li>Fix: Custom chunker now works on legacy runs by extracting elements from .chunks.jsonl files</li>
            </ul>
          </div>
          <div class="version-section">
            <h3 class="version-header">v5.0.2 <span class="version-date">2025-12-02</span></h3>
            <ul>
              <li>Fix: Element bounding boxes now display for legacy chunks-only runs (pre-v5.0)</li>
              <li>Element type filtering works on legacy runs without .elements.jsonl files</li>
            </ul>
          </div>
          <div class="version-section">
            <h3 class="version-header">v5.0.1 <span class="version-date">2025-12-02</span></h3>
            <ul>
              <li>Fix: Legacy runs (pre-v5.0) now discovered correctly by scanning both .elements.jsonl and .chunks.jsonl files</li>
              <li>Add backwards-compatible provider aliases (azure-di, unstructured, unstructured-partition)</li>
            </ul>
          </div>
          <div class="version-section">
            <h3 class="version-header">v5.0 <span class="version-date">2025-12-01</span></h3>
            <ul>
              <li>Custom chunker keeps section headings inside Table/Figure boxes attached to container (captions stay with figures)</li>
              <li>Consecutive section headings merge into a single section chunk (no header-only chunks)</li>
              <li>Paragraphs inside Table bounding boxes filtered to avoid duplicate content</li>
              <li>Tables and Figures included in parent sections instead of standalone chunks</li>
              <li>Element drawer shows hierarchy context mirroring outline view (ancestors/children visible while reviewing)</li>
              <li>Resizable right panel and chunk details drawer</li>
              <li>PDF viewer centered horizontally in available space</li>
              <li>Smart contextual banner for run parameters</li>
              <li>Alternate chunk overlay colors by global index for better visibility</li>
              <li>Remember last opened run across page reloads</li>
              <li>Improved drawer spacing and overlay color consistency</li>
            </ul>
          </div>
          <div class="version-section">
            <h3 class="version-header">v4.4 <span class="version-date">2025-11-28</span></h3>
            <ul>
              <li>Apple Liquid Glass UI redesign with frosted glass effects</li>
              <li>Dark/light theme toggle (follows system preference by default)</li>
              <li>Apple system color palette for element types</li>
              <li>Smooth spring animations on modals, drawer, and toasts</li>
              <li>Enhanced button, card, and form styling with blur effects</li>
              <li>Pill-style tabs and settings items</li>
              <li>Glow effects on review buttons when active</li>
            </ul>
          </div>
          <div class="version-section">
            <h3 class="version-header">v4.3 <span class="version-date">2025-11-27</span></h3>
            <ul>
              <li>Figure elements in Azure DI outline view with child element display</li>
              <li>Direct page number jump via clickable input field</li>
              <li>What's New modal showing cumulative release history</li>
              <li>RTL table columns render correctly for Arabic documents</li>
              <li>PDF legend stays fixed while scrolling</li>
              <li>Azure Document Intelligence is now the default provider</li>
            </ul>
          </div>
          <div class="version-section">
            <h3 class="version-header">v4.2 <span class="version-date">2025-11-26</span></h3>
            <ul>
              <li>Enhanced feedback analysis with provider-level comparisons</li>
              <li>Smoothed scoring using Bayesian formula</li>
              <li>LLM ranks and contrasts providers with shared recommendations</li>
              <li>Per-provider actionability scores (1–10)</li>
              <li>Multi-dimensional LLM insights (per-element suggestions, issue taxonomies, severity levels)</li>
              <li>Enhanced JSON and HTML exports with LLM analysis payloads</li>
              <li>Migrated to OpenAI Responses API (gpt-5-nano default)</li>
              <li>New provider score bar chart</li>
            </ul>
          </div>
          <div class="version-section">
            <h3 class="version-header">v4.1 <span class="version-date">2025-11-26</span></h3>
            <ul>
              <li>Azure Document Intelligence figure crops download as PNGs</li>
              <li>UI previews for cropped figure images</li>
              <li>Simplified Azure settings (only model id shown)</li>
            </ul>
          </div>
          <div class="version-section">
            <h3 class="version-header">v4.0 <span class="version-date">2025-11-25</span></h3>
            <ul>
              <li>Added Unstructured Partition (hosted) provider</li>
              <li>Elements-only workflow for Partition provider</li>
              <li>Switched Docker base image to ECR Public</li>
            </ul>
          </div>
          <div class="version-section">
            <h3 class="version-header">v3.0.2 <span class="version-date">2025-11-25</span></h3>
            <ul>
              <li>Docker build context fix for .env.example</li>
            </ul>
          </div>
          <div class="version-section">
            <h3 class="version-header">v3.0.1 <span class="version-date">2025-11-25</span></h3>
            <ul>
              <li>Docker security fix: exclude .env from build context</li>
            </ul>
          </div>
          <div class="version-section">
            <h3 class="version-header">v3.0 <span class="version-date">2025-11-25</span></h3>
            <ul>
              <li>Azure Document Intelligence markdown rendering</li>
              <li>RTL support for Arabic-heavy documents</li>
              <li>Element outline grouping (paragraphs nest lines)</li>
              <li>Azure paragraph roles as element types</li>
              <li>Overlays scaled to PDF points</li>
            </ul>
          </div>
          <div class="version-section">
            <h3 class="version-header">v2.1 <span class="version-date">2025-11-18</span></h3>
            <ul>
              <li>Persist chunking defaults in run_config</li>
              <li>RTL table display improvements</li>
            </ul>
          </div>
          <div class="version-section">
            <h3 class="version-header">v2.0 <span class="version-date">2025-11-17</span></h3>
            <ul>
              <li>Chunk and element review workflows (Good/Bad ratings)</li>
              <li>Modular frontend architecture</li>
              <li>Chunk overlays synced with Inspect filters</li>
              <li>Review state persistence</li>
            </ul>
          </div>
          <div class="version-section">
            <h3 class="version-header">v1.1 <span class="version-date">2025-11-17</span></h3>
            <ul>
              <li>Polished chunk overlays and drawer interactions</li>
              <li>Metrics highlights sync with drawer choices</li>
            </ul>
          </div>
          <div class="version-section">
            <h3 class="version-header">v1.0 <span class="version-date">2025-11-17</span></h3>
            <ul>
              <li>Initial release: IngestLab &amp; Unstructured Playground</li>
              <li>Metrics view with coverage, cohesion, F1 metrics</li>
              <li>Inspect view with Chunks and Elements tabs</li>
              <li>PDF trimming, gold-table matching</li>
              <li>Docker and Railway deployment support</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <script src="/vendor/chartjs/chart.umd.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.28.1/cytoscape.min.js" defer></script>
    <script src="https://unpkg.com/elkjs@0.9.3/lib/elk.bundled.js" defer></script>
    <script src="https://unpkg.com/cytoscape-elk@2.2.0/dist/cytoscape-elk.js" defer></script>
    <script src="/app-theme.js?v=20251201"></script>
    <script src="/app-state.js?v=20251201" defer></script>
    <script src="/app-ui.js?v=20251201" defer></script>
    <script src="/app-reviews.js?v=20251201" defer></script>
    <script src="/app-overlays.js?v=20251201" defer></script>
    <script src="/app-metrics.js?v=20251201" defer></script>
    <!-- Elements modules (dependencies for app-elements.js) -->
    <script src="/app-elements-filter.js?v=20250126" defer></script>
    <script src="/app-elements-outline.js?v=20250126" defer></script>
    <script src="/app-elements-cards.js?v=20250126" defer></script>
    <script src="/app-elements.js?v=20250126" defer></script>
    <script src="/app-chunks.js?v=20251201" defer></script>
    <script src="/app-feedback.js?v=20251201" defer></script>
    <!-- Images modules (dependencies for app-images.js) -->
    <script src="/app-lightbox.js?v=20250126" defer></script>
    <script src="/app-cytoscape.js?v=20250127g" defer></script>
    <script src="/app-images-pipeline.js?v=20250126" defer></script>
    <script src="/app-images-figures.js?v=20250127b" defer></script>
    <script src="/app-images-upload.js?v=20250129b" defer></script>
    <script src="/app-images-history.js?v=20250129b" defer></script>
    <script src="/app-images.js?v=20250129b" defer></script>
    <!-- Runs modules (dependencies for app-extractions.js) -->
    <script src="/app-pdf.js?v=20250126" defer></script>
    <script src="/app-extraction-jobs.js?v=20250126" defer></script>
    <script src="/app-extraction-preview.js?v=20250126" defer></script>
    <script src="/app-extraction-form.js?v=20250126" defer></script>
    <script src="/app-modal.js?v=20250126" defer></script>
    <script src="/app-extractions.js?v=20250126" defer></script>
    <script src="/app.js?v=20251201" defer></script>
  </body>
  </html>
